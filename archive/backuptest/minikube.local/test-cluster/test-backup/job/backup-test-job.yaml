apiVersion: batch/v1
kind: Job
metadata:
    annotations: {}
    labels:
        app: cluster-backup
        component: test-job
    name: backup-test-job
    namespace: test-backup
spec:
    activeDeadlineSeconds: 300
    backoffLimit: 3
    completionMode: NonIndexed
    completions: 1
    manualSelector: false
    parallelism: 1
    podReplacementPolicy: TerminatingOrFailed
    selector:
        matchLabels:
            batch.kubernetes.io/controller-uid: 17a66d73-7b38-40b5-a62d-6e42d65cf27f
    suspend: false
    template:
        metadata:
            creationTimestamp: null
            labels:
                app: cluster-backup
                batch.kubernetes.io/controller-uid: 17a66d73-7b38-40b5-a62d-6e42d65cf27f
                batch.kubernetes.io/job-name: backup-test-job
                component: test-job
                controller-uid: 17a66d73-7b38-40b5-a62d-6e42d65cf27f
                job-name: backup-test-job
        spec:
            containers:
                - env:
                    - name: CLUSTER_DOMAIN
                      valueFrom:
                        configMapKeyRef:
                            key: cluster-domain
                            name: backup-config
                    - name: CLUSTER_NAME
                      valueFrom:
                        configMapKeyRef:
                            key: cluster-name
                            name: backup-config
                    - name: MINIO_ENDPOINT
                      valueFrom:
                        configMapKeyRef:
                            key: minio-endpoint
                            name: backup-config
                    - name: MINIO_BUCKET
                      valueFrom:
                        configMapKeyRef:
                            key: minio-bucket
                            name: backup-config
                    - name: MINIO_USE_SSL
                      valueFrom:
                        configMapKeyRef:
                            key: minio-use-ssl
                            name: backup-config
                    - name: EXCLUDE_NAMESPACES
                      valueFrom:
                        configMapKeyRef:
                            key: exclude-namespaces
                            name: backup-config
                    - name: BATCH_SIZE
                      valueFrom:
                        configMapKeyRef:
                            key: batch-size
                            name: backup-config
                    - name: RETRY_ATTEMPTS
                      valueFrom:
                        configMapKeyRef:
                            key: retry-attempts
                            name: backup-config
                    - name: RETRY_DELAY
                      valueFrom:
                        configMapKeyRef:
                            key: retry-delay
                            name: backup-config
                    - name: LOG_LEVEL
                      valueFrom:
                        configMapKeyRef:
                            key: log-level
                            name: backup-config
                    - name: MINIO_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                            key: minio-access-key
                            name: backup-secrets
                    - name: MINIO_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                            key: minio-secret-key
                            name: backup-secrets
                  image: cluster-backup:test
                  imagePullPolicy: Never
                  name: backup
                  resources:
                    limits:
                        cpu: 500m
                        memory: 512Mi
                    requests:
                        cpu: 100m
                        memory: 256Mi
                  securityContext:
                    allowPrivilegeEscalation: false
                    capabilities:
                        drop:
                            - ALL
                    readOnlyRootFilesystem: true
                    runAsNonRoot: true
                  terminationMessagePath: /dev/termination-log
                  terminationMessagePolicy: File
                  volumeMounts:
                    - mountPath: /tmp
                      name: tmp
            dnsPolicy: ClusterFirst
            restartPolicy: Never
            schedulerName: default-scheduler
            securityContext:
                fsGroup: 1001
                runAsNonRoot: true
                runAsUser: 1001
            serviceAccount: cluster-backup
            serviceAccountName: cluster-backup
            terminationGracePeriodSeconds: 30
            volumes:
                - emptyDir: {}
                  name: tmp
